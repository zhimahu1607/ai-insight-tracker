# Issue è§¦å‘æ·±åº¦åˆ†æå·¥ä½œæµ
#
# å½“ä»“åº“æ‰€æœ‰è€…åˆ›å»ºå¸¦æœ‰ `agent-task` æ ‡ç­¾ä¸”æ ‡é¢˜ä»¥ `[Analysis]` å¼€å¤´çš„ Issue æ—¶ï¼Œ
# è‡ªåŠ¨æ‰§è¡Œ Multi-Agent æ·±åº¦åˆ†æã€‚
#
# Issue æ ‡é¢˜æ ¼å¼: [Analysis] 2501.12345: Paper Title

name: Deep Analysis

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: write

env:
  # LLM é…ç½®ï¼ˆä» Variables è·å–ï¼‰
  LLM_PROVIDER: ${{ vars.LLM_PROVIDER }}
  LLM_MODEL: ${{ vars.LLM_MODEL }}

jobs:
  deep-analysis:
    name: Multi-Agent Deep Analysis
    runs-on: ubuntu-latest
    
    # æ¡ä»¶éªŒè¯ï¼š
    # 1. Issue æ ‡é¢˜ä»¥ '[Analysis]' å¼€å¤´
    # 2. Issue åˆ›å»ºè€…æ˜¯ä»“åº“æ‰€æœ‰è€…
    if: |
      startsWith(github.event.issue.title, '[Analysis]') &&
      github.event.issue.user.login == github.repository_owner
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1.5 è‡ªåŠ¨æ·»åŠ  agent-task æ ‡ç­¾
      - name: Ensure agent-task label
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['agent-task']
              });
            } catch (e) {
              console.log('æ·»åŠ æ ‡ç­¾å¤±è´¥ (å¯èƒ½æ ‡ç­¾ä¸å­˜åœ¨):', e);
              // ä¸é˜»æ–­æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
            }

      # 2. è®¾ç½® Conda ç¯å¢ƒ
      - name: Setup Micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-file: environment.yml
          environment-name: ai-insight-tracker
          cache-environment: true
          cache-downloads: true

      # 3. å®‰è£…é¢å¤–ä¾èµ–
      - name: Install dependencies
        shell: bash -el {0}
        run: |
          pip install -q tqdm aiofiles

      # 4. æ·»åŠ å¼€å§‹è¯„è®º
      - name: Add start comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ğŸ”¬ **æ·±åº¦åˆ†æå·²å¯åŠ¨**\n\næ­£åœ¨ä½¿ç”¨ Multi-Agent ç³»ç»Ÿè¿›è¡Œè®ºæ–‡æ·±åº¦åˆ†æï¼Œè¯·ç¨å€™...\n\né¢„è®¡è€—æ—¶ï¼š3-5 åˆ†é’Ÿ'
            });

      # 4.5 æ ‡è®°ä¸ºåˆ†æä¸­å¹¶æäº¤
      - name: Mark as processing
        shell: bash -el {0}
        run: |
          # æå– Paper ID
          PAPER_ID=$(echo "${{ github.event.issue.title }}" | grep -oP '\d+\.\d+' | head -1)
          if [ -z "$PAPER_ID" ]; then
            echo "æ— æ³•æå– Paper ID"
            exit 1
          fi
          echo "PAPER_ID=$PAPER_ID" >> $GITHUB_ENV
          
          # æ›´æ–°çŠ¶æ€æ–‡ä»¶
          python scripts/update_analysis_status.py add "$PAPER_ID"
          
          # æäº¤æ›´æ”¹
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/analysis/deep_analysis_status.json
          
          if git diff --staged --quiet; then
            echo "Status file unchanged"
          else
            git commit -m "ğŸš§ Start analysis: $PAPER_ID"
            # å°è¯• pushï¼Œå¦‚æœå¤±è´¥åˆ™ pull rebase å† push
            git push || (git pull --rebase && git push)
          fi

      # 5. æ‰§è¡Œæ·±åº¦åˆ†æ
      - name: Run deep analysis
        id: analysis
        shell: bash -el {0}
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          python scripts/deep_analysis.py \
            --issue-number "${{ github.event.issue.number }}" \
            --issue-title "${{ github.event.issue.title }}" \
            --issue-body "${{ github.event.issue.body }}" \
            --repo "${{ github.repository }}" \
            --skip-config-check
          
          echo "analysis_success=true" >> $GITHUB_OUTPUT

      # 6. è¯»å–åˆ†æç»“æœ
      - name: Read analysis result
        id: result
        if: steps.analysis.outputs.analysis_success == 'true'
        run: |
          # ä» Issue æ ‡é¢˜æå–è®ºæ–‡ ID
          PAPER_ID=$(echo "${{ github.event.issue.title }}" | grep -oP '\d+\.\d+' | head -1)
          echo "paper_id=$PAPER_ID" >> $GITHUB_OUTPUT
          
          # è¯»å–åˆ†æç»“æœ
          RESULT_FILE="data/analysis/deep/${PAPER_ID}.md"
          if [ -f "$RESULT_FILE" ]; then
            # è¯»å–æ–‡ä»¶å†…å®¹ï¼ˆè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼‰
            CONTENT=$(cat "$RESULT_FILE")
            echo "result_exists=true" >> $GITHUB_OUTPUT
          else
            echo "result_exists=false" >> $GITHUB_OUTPUT
          fi

      # 7. æ·»åŠ åˆ†æç»“æœè¯„è®º
      - name: Add result comment
        if: steps.result.outputs.result_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const paperId = '${{ steps.result.outputs.paper_id }}';
            const resultFile = `data/analysis/deep/${paperId}.md`;
            
            let content = '';
            try {
              content = fs.readFileSync(resultFile, 'utf8');
            } catch (e) {
              content = 'åˆ†æç»“æœè¯»å–å¤±è´¥';
            }
            
            // æˆªæ–­è¿‡é•¿çš„å†…å®¹ï¼ˆGitHub è¯„è®ºæœ‰å­—ç¬¦é™åˆ¶ï¼‰
            const maxLength = 60000;
            if (content.length > maxLength) {
              content = content.substring(0, maxLength) + '\n\n... (å†…å®¹è¿‡é•¿å·²æˆªæ–­)';
            }
            
            const body = `## ğŸ¯ æ·±åº¦åˆ†æå®Œæˆ\n\n${content}\n\n---\n\n*ç”± AI Insight Tracker Multi-Agent ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      # 8. æ·»åŠ å®Œæˆæ ‡ç­¾
      - name: Add completion label
        if: steps.analysis.outputs.analysis_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['analysis-complete']
            });

      # 9. æäº¤åˆ†æç»“æœ
      - name: Commit analysis result
        if: steps.result.outputs.result_exists == 'true' || always() # ç¡®ä¿å³ä½¿åˆ†æå¤±è´¥ä¹Ÿå°è¯•æ¸…ç†çŠ¶æ€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ç§»é™¤å¤„ç†çŠ¶æ€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ ! -z "$PAPER_ID" ]; then
             python scripts/update_analysis_status.py remove "$PAPER_ID"
             git add data/analysis/deep_analysis_status.json
          fi
          
          # æ·»åŠ åˆ†æç»“æœï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -d "data/analysis/" ]; then
             git add data/analysis/
          fi
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„åˆ†æç»“æœéœ€è¦æäº¤"
          else
            git commit -m "ğŸ”¬ Deep analysis update: $PAPER_ID"
            git push || (git pull --rebase && git push)
          fi

      # 10. å‘é€é£ä¹¦é€šçŸ¥
      - name: Send Feishu notification
        if: steps.analysis.outputs.analysis_success == 'true'
        shell: bash -el {0}
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/notify.py \
            --type deep \
            --paper-id "${{ steps.result.outputs.paper_id }}" \
            --issue-url "https://github.com/${{ github.repository }}/issues/${{ github.event.issue.number }}" \
            || echo "é€šçŸ¥å‘é€å¤±è´¥æˆ–æœªé…ç½®ï¼Œç»§ç»­æ‰§è¡Œ"

  # ============================================================
  # åˆ†æå¤±è´¥å¤„ç†
  # ============================================================
  handle-failure:
    name: Handle Analysis Failure
    runs-on: ubuntu-latest
    needs: deep-analysis
    if: failure()
    
    steps:
      - name: Add failure comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âŒ **æ·±åº¦åˆ†æå¤±è´¥**\n\nåˆ†æè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·æŸ¥çœ‹ [GitHub Actions æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) äº†è§£è¯¦æƒ…ã€‚\n\nå¯èƒ½çš„åŸå› ï¼š\n- è®ºæ–‡ ID æ ¼å¼é”™è¯¯\n- è®ºæ–‡åœ¨ arXiv ä¸Šä¸å­˜åœ¨\n- API è°ƒç”¨å¤±è´¥\n- è¶…æ—¶'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['analysis-failed']
            });

