# æ¯æ—¥å®šæ—¶å·¥ä½œæµ
#
# å®šæ—¶è·å– arXiv è®ºæ–‡å’Œ RSS çƒ­ç‚¹ï¼Œæ‰§è¡Œæµ…åº¦åˆ†æï¼Œç”Ÿæˆæ—¥æŠ¥ï¼Œå‘é€é€šçŸ¥ï¼Œéƒ¨ç½²å‰ç«¯ã€‚
#
# è§¦å‘æ¡ä»¶:
#   - å®šæ—¶: æ¯å¤© UTC 01:30 (åŒ—äº¬æ—¶é—´ 09:30)
#   - æ‰‹åŠ¨: workflow_dispatch

name: Daily Crawl & Deploy

on:
  schedule:
    - cron: "30 1 * * *"  # UTC 01:30 (åŒ—äº¬æ—¶é—´ 09:30)
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      skip_notify:
        description: 'è·³è¿‡é£ä¹¦é€šçŸ¥'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

env:
  # LLM é…ç½®ï¼ˆä» Variables è·å–ï¼‰
  LLM_PROVIDER: ${{ vars.LLM_PROVIDER }}
  LLM_MODEL: ${{ vars.LLM_MODEL }}
  
  # arXiv åˆ†ç±»ï¼ˆå¯é€‰ï¼Œæœ‰é»˜è®¤å€¼ï¼‰
  CATEGORIES: ${{ vars.CATEGORIES }}
  
  # è¯­è¨€é…ç½®ï¼ˆå¯é€‰ï¼‰
  LANGUAGE: ${{ vars.LANGUAGE }}

jobs:
  # ============================================================
  # Job 1: æ•°æ®è·å–ä¸åˆ†æ
  # ============================================================
  fetch-and-analyze:
    name: Fetch & Analyze
    runs-on: ubuntu-latest
    
    outputs:
      has_new_content: ${{ steps.arxiv.outputs.has_new_content }}
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äº push

      # 2. è®¾ç½® Conda ç¯å¢ƒ
      - name: Setup Micromamba
        uses: mamba-org/setup-micromamba@v2
        with:
          environment-file: environment.yml
          environment-name: ai-insight-tracker
          cache-environment: true
          cache-downloads: true

      # 3. å®‰è£…é¢å¤–ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
      - name: Install dependencies
        shell: bash -el {0}
        run: |
          # ç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½å·²å®‰è£…
          pip install -q tqdm aiofiles

      # 4. éªŒè¯é…ç½®
      - name: Validate configuration
        shell: bash -el {0}
        env:
          # API Keyï¼ˆä» Secrets è·å–ï¼‰
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          python scripts/validate_config.py

      # 5. è·å– arXiv è®ºæ–‡
      - name: Fetch arXiv papers
        id: arxiv
        shell: bash -el {0}
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          python scripts/daily_crawl.py --task arxiv --skip-config-check
          exit_code=$?
          
          if [ $exit_code -eq 0 ]; then
            echo "has_new_content=true" >> $GITHUB_OUTPUT
            echo "âœ… å‘ç°æ–°è®ºæ–‡"
          elif [ $exit_code -eq 2 ]; then
            echo "has_new_content=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ æ— æ–°è®ºæ–‡ï¼Œå°†è·³è¿‡åç»­åˆ†ææ­¥éª¤"
          else
            echo "âŒ arXiv è·å–å‡ºé”™"
            exit $exit_code
          fi

      # 6. è·å– RSS çƒ­ç‚¹ï¼ˆä»…å½“æœ‰æ–°è®ºæ–‡æ—¶ï¼‰
      - name: Fetch RSS news
        if: steps.arxiv.outputs.has_new_content == 'true'
        shell: bash -el {0}
        run: |
          python scripts/daily_crawl.py --task rss --skip-config-check

      # 7. æµ…åº¦åˆ†æï¼ˆä»…å½“æœ‰æ–°è®ºæ–‡æ—¶ï¼‰
      - name: Light analysis
        if: steps.arxiv.outputs.has_new_content == 'true'
        shell: bash -el {0}
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          python scripts/daily_crawl.py --task analyze --skip-config-check

      # 8. ç”Ÿæˆæ—¥æŠ¥ï¼ˆä»…å½“æœ‰æ–°è®ºæ–‡æ—¶ï¼‰
      - name: Generate daily report
        if: steps.arxiv.outputs.has_new_content == 'true'
        shell: bash -el {0}
        env:
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
        run: |
          python scripts/daily_crawl.py --task summary --skip-config-check

      # 9. æ›´æ–°æ–‡ä»¶ç´¢å¼•
      - name: Update file list
        if: steps.arxiv.outputs.has_new_content == 'true'
        shell: bash -el {0}
        run: |
          python scripts/daily_crawl.py --task update-file-list --skip-config-check

      # 10. å‘é€é£ä¹¦é€šçŸ¥ï¼ˆä»…å½“æœ‰æ–°è®ºæ–‡ä¸”æœªè·³è¿‡ï¼‰
      - name: Send Feishu notification
        if: |
          steps.arxiv.outputs.has_new_content == 'true' && 
          github.event.inputs.skip_notify != 'true'
        shell: bash -el {0}
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python scripts/notify.py --type daily || echo "é€šçŸ¥å‘é€å¤±è´¥æˆ–æœªé…ç½®ï¼Œç»§ç»­æ‰§è¡Œ"

      # 11. æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: Commit and push changes
        if: steps.arxiv.outputs.has_new_content == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ•°æ®æ–‡ä»¶
          git add data/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"
          else
            git commit -m "ğŸ“Š Daily update: $(date +%Y-%m-%d)"
            git push
          fi

  # ============================================================
  # Job 2: æ„å»ºå‰ç«¯å¹¶éƒ¨ç½²
  # ============================================================
  build-frontend:
    name: Build & Deploy Frontend
    runs-on: ubuntu-latest
    needs: fetch-and-analyze
    # å³ä½¿æ— æ–°å†…å®¹ä¹Ÿéƒ¨ç½²ï¼ˆå¯èƒ½æœ‰å…¶ä»–æ›´æ–°ï¼‰
    if: always() && needs.fetch-and-analyze.result != 'failure'
    
    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆåŒ…æ‹¬æœ€æ–°æäº¤ï¼‰
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      # 2. æ‹‰å–æœ€æ–°æ›´æ”¹ï¼ˆfetch-and-analyze å¯èƒ½æ¨é€äº†æ–°æ•°æ®ï¼‰
      - name: Pull latest changes
        run: |
          git pull origin ${{ github.ref_name }} || true

      # 3. è®¾ç½® Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'app/frontend/package-lock.json'

      # 4. å®‰è£…å‰ç«¯ä¾èµ–
      - name: Install frontend dependencies
        working-directory: app/frontend
        run: npm ci

      # 5. æ„å»ºå‰ç«¯
      - name: Build frontend
        working-directory: app/frontend
        run: npm run build

      # 6. å¤åˆ¶æ•°æ®æ–‡ä»¶åˆ° dist
      - name: Copy data files to dist
        run: |
          # åˆ›å»ºæ•°æ®ç›®å½•
          mkdir -p app/frontend/dist/data
          
          # å¤åˆ¶æ•°æ®æ–‡ä»¶ï¼ˆä½¿ç”¨æ¡ä»¶åˆ¤æ–­ï¼Œé¿å…ç›®å½•ä¸å­˜åœ¨æ—¶æŠ¥é”™ï¼‰
          if [ -d "data/papers" ]; then
            cp -r data/papers app/frontend/dist/data/
          else
            echo "Warning: data/papers not found, creating empty directory"
            mkdir -p app/frontend/dist/data/papers
          fi
          
          if [ -d "data/news" ]; then
            cp -r data/news app/frontend/dist/data/
          else
            echo "Warning: data/news not found, creating empty directory"
            mkdir -p app/frontend/dist/data/news
          fi
          
          if [ -d "data/reports" ]; then
            cp -r data/reports app/frontend/dist/data/
          else
            echo "Warning: data/reports not found, creating empty directory"
            mkdir -p app/frontend/dist/data/reports
          fi
          
          # file-list.json æ˜¯å¿…éœ€çš„ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºç©ºçš„
          if [ -f "data/file-list.json" ]; then
            cp data/file-list.json app/frontend/dist/data/
          else
            echo "Warning: file-list.json not found, creating empty one"
            echo '{"papers":[],"news":[],"reports":[]}' > app/frontend/dist/data/file-list.json
          fi
          
          # å¦‚æœæœ‰æ·±åº¦åˆ†æç»“æœä¹Ÿå¤åˆ¶
          if [ -d "data/analysis" ]; then
            cp -r data/analysis app/frontend/dist/data/
          fi
          
          echo "âœ… æ•°æ®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          ls -la app/frontend/dist/data/

      # 7. éƒ¨ç½²åˆ° gh-pages åˆ†æ”¯
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./app/frontend/dist
          publish_branch: gh-pages
          commit_message: 'ğŸš€ Deploy: ${{ github.sha }}'

  # ============================================================
  # Job 3: å¤±è´¥é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
  # ============================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [fetch-and-analyze, build-frontend]
    if: failure()
    
    steps:
      - name: Send failure notification
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          if [ -n "$FEISHU_WEBHOOK_URL" ]; then
            curl -X POST "$FEISHU_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "msg_type": "interactive",
                "card": {
                  "header": {
                    "title": {
                      "tag": "plain_text",
                      "content": "âš ï¸ AI Insight Tracker å·¥ä½œæµå¤±è´¥"
                    },
                    "template": "red"
                  },
                  "elements": [
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "æ¯æ—¥å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ GitHub Actions æ—¥å¿—ã€‚\n\n**ä»“åº“**: '"${{ github.repository }}"'\n**è¿è¡Œ ID**: '"${{ github.run_id }}"'"
                      }
                    },
                    {
                      "tag": "action",
                      "actions": [
                        {
                          "tag": "button",
                          "text": {
                            "tag": "plain_text",
                            "content": "æŸ¥çœ‹æ—¥å¿—"
                          },
                          "type": "primary",
                          "url": "https://github.com/'"${{ github.repository }}"'/actions/runs/'"${{ github.run_id }}"'"
                        }
                      ]
                    }
                  ]
                }
              }'
          else
            echo "é£ä¹¦ Webhook æœªé…ç½®ï¼Œè·³è¿‡å¤±è´¥é€šçŸ¥"
          fi

